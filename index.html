<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mallard Court — Check In</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
</head>

<body>
  <header class="header">
    <img src="logo.png" alt="Company Logo" class="logo" />
    <h1>Mallard Court Office Entry Log</h1>
  </header>

  <main class="container">
    <section class="card checkin-card">
      <form id="checkinForm" autocomplete="off">
        <label for="name">Your name</label>
        <input id="name" name="name" type="text" placeholder="Enter your name" required autofocus />

        <label for="sap">SAP Number</label>
        <input id="sap" name="sap" type="number" placeholder="Enter your SAP Number" required pattern="\d*" inputmode="numeric" />

        <button type="submit" id="submitBtn">Check In</button>
      </form>

      <div id="status" class="status" aria-live="polite"></div>
      <p class="help">Make sure location is enabled on your phone. Check-in is allowed only within the office radius.</p>
    </section>
  </main>

  <footer class="footer">
    <small>Admin → <a href="admin.html">Admin page (password protected)</a></small>
  </footer>

  <script>
    // ---------------- CONFIG ----------------
    const SUPABASE_URL = 'https://wxczoigytxeepkfhvifm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind4Y3pvaWd5dHhlZXBrZmh2aWZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2ODE2NzUsImV4cCI6MjA3NTI1NzY3NX0.PjHcgrZVAa5G56DseG5G9Qf1t3cE5wXOkat_GWhuQE0';
    const OFFICE_LAT = 51.14688;     // your office latitude
    const OFFICE_LON = -2.99605;     // your office longitude
    const ALLOWED_RADIUS_METRES = 100; // check-in radius
    // ----------------------------------------

    // init Supabase client
    const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // helper: geolocation → Promise
    function getPosition(options = {}) {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error('Geolocation not supported'));
        navigator.geolocation.getCurrentPosition(resolve, reject, options);
      });
    }

    // haversine distance (metres)
    function haversineDistanceMetres(lat1, lon1, lat2, lon2){
      const toRad = x => x * Math.PI / 180;
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // save entry to Supabase
    async function saveEntryToSupabase(name, sap, lat, lon, distance_m) {
      try {
        const { data, error } = await supabase
          .from('checkins')
          .insert([{
            name,
            sap: String(sap),
            ts: new Date().toISOString(),
            lat,
            lon,
            distance_m
          }]);
        if (error) throw error;
        console.log('✅ Data saved:', data);
        return true;
      } catch (err) {
        console.error('❌ Supabase insert error:', err.message);
        alert(`Supabase error: ${err.message}`); // shows exact reason
        return false;
      }
    }

    // form submit handler
    document.getElementById('checkinForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const nameEl = document.getElementById('name');
      const sapEl = document.getElementById('sap');
      const statusEl = document.getElementById('status');

      const name = nameEl.value.trim();
      const sap = sapEl.value.trim();

      if (!name || !sap) {
        statusEl.textContent = '❌ Please fill in both Name and SAP number.';
        statusEl.classList.add('show');
        setTimeout(() => statusEl.classList.remove('show'), 2500);
        return;
      }

      if (isNaN(sap)) {
        statusEl.textContent = '❌ SAP Number must be numeric.';
        statusEl.classList.add('show');
        setTimeout(() => statusEl.classList.remove('show'), 2500);
        return;
      }

      statusEl.textContent = 'Getting location…';
      statusEl.classList.add('show');

      const pos = await getPosition({ timeout: 10000 }).catch(err => {
        statusEl.textContent = '❌ Location required for check-in. Please enable location.';
        setTimeout(() => statusEl.classList.remove('show'), 4000);
        return null;
      });
      if (!pos) return;

      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const distance = Math.round(haversineDistanceMetres(lat, lon, OFFICE_LAT, OFFICE_LON));

      if (distance > ALLOWED_RADIUS_METRES) {
        statusEl.textContent = `You are ${distance} m away — check-in only allowed within ${ALLOWED_RADIUS_METRES} m.`;
        setTimeout(() => statusEl.classList.remove('show'), 4000);
        return;
      }

      // save entry
      const ok = await saveEntryToSupabase(name, sap, lat, lon, distance);
      if (ok) {
        statusEl.textContent = '✅ Checked in — thank you!';
        confetti({ particleCount: 80, spread: 60, origin: { y: 0.6 } });
        nameEl.value = '';
        sapEl.value = '';
      } else {
        statusEl.textContent = '❌ Error saving entry — please try again.';
      }

      setTimeout(() => statusEl.classList.remove('show'), 2500);
    });
  </script>
</body>
</html>
